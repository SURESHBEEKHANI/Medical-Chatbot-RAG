name: Deploy Medical Chatbot Application to AWS EC2

on:
  push:
    branches: [main]

jobs:
  # =========================
  # Continuous Integration
  # =========================
  Continuous-Integration:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Verify AWS_REGION secret
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          if [ -z "$AWS_REGION" ]; then
            echo "::error::AWS_REGION secret is missing"
            exit 1
          fi
          echo "AWS_REGION is set to $AWS_REGION"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push backend image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPO_BACKEND: ${{ secrets.ECR_REPO_BACKEND }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPO_BACKEND:latest ./backend
          docker push $ECR_REGISTRY/$ECR_REPO_BACKEND:latest

      - name: Build and push frontend image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPO_FRONTEND: ${{ secrets.ECR_REPO_FRONTEND }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPO_FRONTEND:latest ./frontend
          docker push $ECR_REGISTRY/$ECR_REPO_FRONTEND:latest


  # =========================
  # Continuous Deployment
  # =========================
  Continuous-Deployment:
    needs: Continuous-Integration
    runs-on: [self-hosted, linux, x64]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Verify checkout and list files
        run: |
          echo "=== Current Directory ==="
          pwd
          echo ""
          echo "=== Listing files ==="
          ls -la
          echo ""
          echo "=== Checking for docker-compose.prod.yml ==="
          if [ -f docker-compose.prod.yml ]; then
            echo "✅ docker-compose.prod.yml exists"
          else
            echo "❌ docker-compose.prod.yml NOT FOUND"
            exit 1
          fi
          echo ""
          echo "=== Checking for nginx.conf ==="
          if [ -f nginx.conf ]; then
            echo "✅ nginx.conf exists"
          else
            echo "⚠️ nginx.conf NOT FOUND (warning only)"
          fi

      - name: Verify Docker installation
        run: |
          echo "=== Docker Version ==="
          docker --version || (echo "ERROR: Docker is not installed" && exit 1)
          
          echo "=== Docker Compose Version ==="
          if docker compose version &> /dev/null 2>&1; then
            docker compose version
            echo "Using Docker Compose V2"
          elif docker-compose --version &> /dev/null 2>&1; then
            docker-compose --version
            echo "Using Docker Compose V1"
          else
            echo "WARNING: Neither docker compose nor docker-compose found"
          fi
          
          echo "=== Docker Info ==="
          docker info | head -20 || true
          
          echo "=== Testing Docker Access ==="
          docker ps || (echo "ERROR: Cannot access Docker daemon. Check permissions." && exit 1)

      - name: Verify AWS secrets are set
        run: |
          echo "=== Checking AWS Secrets ==="
          if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
            echo "❌ AWS_ACCESS_KEY_ID secret is missing"
            exit 1
          else
            echo "✅ AWS_ACCESS_KEY_ID is set"
          fi
          
          if [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
            echo "❌ AWS_SECRET_ACCESS_KEY secret is missing"
            exit 1
          else
            echo "✅ AWS_SECRET_ACCESS_KEY is set"
          fi
          
          if [ -z "${{ secrets.AWS_REGION }}" ]; then
            echo "❌ AWS_REGION secret is missing"
            exit 1
          else
            echo "✅ AWS_REGION is set to ${{ secrets.AWS_REGION }}"
          fi
          
          if [ -z "${{ secrets.ECR_REPO_BACKEND }}" ]; then
            echo "❌ ECR_REPO_BACKEND secret is missing"
            exit 1
          else
            echo "✅ ECR_REPO_BACKEND is set"
          fi
          
          if [ -z "${{ secrets.ECR_REPO_FRONTEND }}" ]; then
            echo "❌ ECR_REPO_FRONTEND secret is missing"
            exit 1
          else
            echo "✅ ECR_REPO_FRONTEND is set"
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Verify AWS CLI installation
        run: |
          echo "=== Checking AWS CLI ==="
          if ! command -v aws &> /dev/null; then
            echo "❌ AWS CLI is not installed"
            echo "Install it with: sudo apt-get update && sudo apt-get install -y awscli"
            exit 1
          fi
          aws --version
          echo "✅ AWS CLI is installed"

      - name: Verify AWS credentials
        run: |
          echo "=== Testing AWS credentials ==="
          if ! aws sts get-caller-identity; then
            echo "❌ AWS credentials verification failed"
            echo "Check that:"
            echo "  1. AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY secrets are correct"
            echo "  2. The IAM user has necessary permissions"
            exit 1
          fi
          echo "✅ AWS credentials are valid"

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Verify ECR login
        run: |
          echo "=== ECR Registry ==="
          echo "Registry: ${{ steps.login-ecr.outputs.registry }}"
          if [ -z "${{ steps.login-ecr.outputs.registry }}" ]; then
            echo "❌ ECR registry is empty"
            exit 1
          fi
          echo "✅ ECR login successful"

      - name: Stop existing containers
        run: |
          echo "Stopping existing containers..."
          if docker compose version &> /dev/null 2>&1; then
            docker compose -f docker-compose.prod.yml down || true
          elif docker-compose --version &> /dev/null 2>&1; then
            docker-compose -f docker-compose.prod.yml down || true
          else
            echo "WARNING: Cannot stop containers - docker compose not available"
          fi
          
          # Also try to stop containers by name as fallback
          docker stop medical-chatbot-backend medical-chatbot-frontend medical-chatbot-nginx 2>/dev/null || true
          docker rm medical-chatbot-backend medical-chatbot-frontend medical-chatbot-nginx 2>/dev/null || true
          
          echo "✅ Cleanup completed"

      - name: Pull latest images
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPO_BACKEND: ${{ secrets.ECR_REPO_BACKEND }}
          ECR_REPO_FRONTEND: ${{ secrets.ECR_REPO_FRONTEND }}
        run: |
          BACKEND_IMAGE="$ECR_REGISTRY/$ECR_REPO_BACKEND:latest"
          FRONTEND_IMAGE="$ECR_REGISTRY/$ECR_REPO_FRONTEND:latest"
          
          echo "Pulling backend image: $BACKEND_IMAGE"
          if ! docker pull "$BACKEND_IMAGE"; then
            echo "ERROR: Failed to pull backend image"
            exit 1
          fi
          
          echo "Pulling frontend image: $FRONTEND_IMAGE"
          if ! docker pull "$FRONTEND_IMAGE"; then
            echo "ERROR: Failed to pull frontend image"
            exit 1
          fi
          
          echo "Verifying images..."
          docker images | grep -E "($ECR_REPO_BACKEND|$ECR_REPO_FRONTEND)" || true
          
          # Verify images exist
          if ! docker image inspect "$BACKEND_IMAGE" &> /dev/null; then
            echo "ERROR: Backend image not found after pull"
            exit 1
          fi
          
          if ! docker image inspect "$FRONTEND_IMAGE" &> /dev/null; then
            echo "ERROR: Frontend image not found after pull"
            exit 1
          fi
          
          echo "✅ Images pulled and verified successfully"

      - name: Verify deployment files
        run: |
          test -f docker-compose.prod.yml || (echo "ERROR: docker-compose.prod.yml not found!" && exit 1)
          test -f nginx.conf || (echo "WARNING: nginx.conf not found!" || true)
          echo "✅ Deployment files verified"

      - name: Deploy application
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPO_BACKEND: ${{ secrets.ECR_REPO_BACKEND }}
          ECR_REPO_FRONTEND: ${{ secrets.ECR_REPO_FRONTEND }}
          PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          LANGCHAIN_API_KEY: ${{ secrets.LANGCHAIN_API_KEY }}
          LANGCHAIN_PROJECT: ${{ secrets.LANGCHAIN_PROJECT }}
          LANGCHAIN_TRACING_V2: "true"
        run: |
          echo "Deploying with ECR_REGISTRY=$ECR_REGISTRY"
          echo "Backend image: $ECR_REGISTRY/$ECR_REPO_BACKEND:latest"
          echo "Frontend image: $ECR_REGISTRY/$ECR_REPO_FRONTEND:latest"
          
          # Export environment variables for docker-compose
          export ECR_REGISTRY ECR_REPO_BACKEND ECR_REPO_FRONTEND
          export PINECONE_API_KEY GROQ_API_KEY LANGCHAIN_API_KEY LANGCHAIN_PROJECT LANGCHAIN_TRACING_V2
          
          # Determine which docker compose command to use
          if docker compose version &> /dev/null 2>&1; then
            echo "Using 'docker compose' (V2)"
            docker compose -f docker-compose.prod.yml up -d
          elif docker-compose --version &> /dev/null 2>&1; then
            echo "Using 'docker-compose' (V1)"
            docker-compose -f docker-compose.prod.yml up -d
          else
            echo "ERROR: Neither 'docker compose' nor 'docker-compose' is available"
            exit 1
          fi
          
          # Wait a moment for containers to start
          sleep 5
          
          # Verify containers are running
          if docker compose version &> /dev/null 2>&1; then
            docker compose -f docker-compose.prod.yml ps
          else
            docker-compose -f docker-compose.prod.yml ps
          fi

      - name: Verify deployment
        run: |
          echo "=== Container Status ==="
          docker ps -a
          echo ""
          echo "=== Container Logs ==="
          if docker compose version &> /dev/null 2>&1; then
            docker compose -f docker-compose.prod.yml logs --tail=50
          else
            docker-compose -f docker-compose.prod.yml logs --tail=50
          fi
          echo ""
          echo "=== Health Check ==="
          if docker compose version &> /dev/null 2>&1; then
            docker compose -f docker-compose.prod.yml ps
          else
            docker-compose -f docker-compose.prod.yml ps
          fi
